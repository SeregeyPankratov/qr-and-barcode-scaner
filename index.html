<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–°–∫–∞–Ω–µ—Ä QR / –®—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤</title>
  <script src="https://telegram.org/js/telegram-web-app.js?57"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; text-align: center; }
    #reader { width: 300px; margin: 20px auto; }
    #status { color: red; font-size: 14px; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>üì∑ –°–∫–∞–Ω–µ—Ä QR / –®—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤</h2>
  <div id="reader"></div>
  <div id="status"></div>

  <script>
    const statusDiv = document.getElementById("status");

    if (window.Telegram && Telegram.WebApp) {
      Telegram.WebApp.ready();
      Telegram.WebApp.expand();
      console.log("‚úÖ Telegram WebApp API –¥–æ—Å—Ç—É–ø–µ–Ω");
    } else {
      statusDiv.innerText = "‚ùå Telegram WebApp API –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω. –ó–∞–ø—É—Å–∫ –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω.";
      console.error("Telegram WebApp API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω");
    }

    const html5QrCode = new Html5Qrcode("reader");

    function startScanner(cameraId) {
      html5QrCode.start(
        cameraId,
        {
          fps: 10,
          qrbox: { width: 250, height: 250 },
          aspectRatio: 1.333 // –£–ª—É—á—à–∞–µ—Ç —Ñ–æ–∫—É—Å –Ω–∞ QR
        },
        (decodedText) => {
          console.log("‚úÖ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ:", decodedText);
          if (window.Telegram && Telegram.WebApp) {
            Telegram.WebApp.sendData(decodedText);
          } else {
            alert("Telegram WebApp API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.\n–î–∞–Ω–Ω—ã–µ: " + decodedText);
          }
          html5QrCode.stop();
        },
        (errorMessage) => {
          // –û—à–∏–±–∫–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –º–æ–∂–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å
        }
      );
    }

    Html5Qrcode.getCameras().then(devices => {
      if (devices.length === 0) {
        statusDiv.innerText = "‚ùå –ö–∞–º–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã";
        return;
      }

      // –ü–æ–ø—ã—Ç–∫–∞ –≤—ã–±—Ä–∞—Ç—å –∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É
      let backCamera = devices.find(device => /back|rear|–∑–∞–¥/i.test(device.label));
      const cameraId = backCamera ? backCamera.id : devices[0].id;

      if (!backCamera) {
        console.warn("‚ö†Ô∏è –ó–∞–¥–Ω—è—è –∫–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–µ—Ä–≤–∞—è –¥–æ—Å—Ç—É–ø–Ω–∞—è.");
      }

      startScanner(cameraId);
    }).catch(err => {
      statusDiv.innerText = "‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–∞–º–µ—Ä: " + err;
    });
  </script>
</body>
</html>
