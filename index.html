<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>QR Сканер</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background-color: black;
      overflow: hidden;
      font-family: Arial, sans-serif;
      color: white;
    }

    #reader {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: 1;
    }

    .qr-frame {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 220px;
      height: 220px;
      transform: translate(-50%, -50%);
      border: 2px solid lime;
      z-index: 2;
      box-sizing: border-box;
    }

    #cameraSelect {
      position: absolute;
      top: env(safe-area-inset-top, 10px);
      left: 50%;
      transform: translateX(-50%);
      z-index: 3;
      background: rgba(0, 0, 0, 0.7);
      border: 1px solid #ccc;
      color: white;
      font-size: 16px;
      padding: 6px 12px;
      border-radius: 5px;
    }

    @media (max-width: 480px) {
      .qr-frame {
        width: 180px;
        height: 180px;
      }

      #cameraSelect {
        font-size: 14px;
        padding: 4px 10px;
      }
    }
  </style>
  <script src="https://unpkg.com/html5-qrcode@2.3.9"></script>
</head>
<body>
  <select id="cameraSelect"></select>
  <div id="reader"></div>
  <div class="qr-frame"></div>

  <script>
    const cameraSelect = document.getElementById("cameraSelect");
    const reader = new Html5Qrcode("reader");
    let currentCameraId = null;

    const qrConfig = {
      fps: 10,
      qrbox: { width: 220, height: 220 },
      aspectRatio: 1.0,
      disableFlip: true,
    };

    function onScanSuccess(decodedText, decodedResult) {
      console.log("Scanned:", decodedText);

      if (window.Telegram?.WebApp?.sendData) {
        Telegram.WebApp.sendData(decodedText);
      } else {
        alert("Результат: " + decodedText);
      }

      reader.stop();
    }

    function onScanFailure(error) {
      // Ничего не делаем на неудачу
    }

    function startScanner(cameraId) {
      if (currentCameraId) {
        reader.stop().then(() => {
          reader.start(cameraId, qrConfig, onScanSuccess, onScanFailure);
        });
      } else {
        reader.start(cameraId, qrConfig, onScanSuccess, onScanFailure);
      }
      currentCameraId = cameraId;
    }

    Html5Qrcode.getCameras().then(devices => {
      if (devices.length === 0) {
        alert("Камеры не найдены");
        return;
      }

      devices.forEach(device => {
        const option = document.createElement("option");
        option.value = device.id;
        option.text = device.label || `Камера ${cameraSelect.length + 1}`;
        cameraSelect.appendChild(option);
      });

      const backCam = devices.find(d => d.label.toLowerCase().includes("back")) || devices[0];
      cameraSelect.value = backCam.id;
      startScanner(backCam.id);
    });

    cameraSelect.addEventListener("change", (e) => {
      startScanner(e.target.value);
    });

    if (Telegram?.WebApp) {
      Telegram.WebApp.ready();
    }
  </script>
</body>
</html>
