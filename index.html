<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–°–∫–∞–Ω–µ—Ä —Å –≤—ã–±–æ—Ä–æ–º –∫–∞–º–µ—Ä—ã</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; text-align: center; }
    #reader { width: 300px; margin: 20px auto; }
    select { margin-top: 10px; padding: 5px; }
  </style>
</head>
<body>
  <h2>üì∑ –°–∫–∞–Ω–µ—Ä QR / –®—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤</h2>

  <select id="camera-select"></select>
  <div id="reader"></div>

  <script>
    const html5QrCode = new Html5Qrcode("reader");
    const cameraSelect = document.getElementById("camera-select");
    let currentCameraId = null;

    async function startScanner(cameraId) {
      if (!window.Telegram || !Telegram.WebApp) {
        alert("‚ùå Telegram WebApp API –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω. –ó–∞–ø—É—Å–∫ –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω.");
        return;
      }

      await stopScanner();

      html5QrCode.start(
        cameraId,
        { fps: 10, qrbox: 250 },
        (decodedText) => {
          console.log("‚úÖ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ:", decodedText);
          Telegram.WebApp.ready();
          Telegram.WebApp.sendData(decodedText);
          html5QrCode.stop();
        },
        (errorMessage) => {
          // –û—à–∏–±–∫–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ –≤—ã–≤–æ–¥–∏–º
        }
      ).then(() => {
        currentCameraId = cameraId;
      }).catch(err => {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞:", err);
      });
    }

    function stopScanner() {
      if (html5QrCode.getState() === Html5QrcodeScannerState.SCANNING) {
        return html5QrCode.stop().catch(() => {});
      }
      return Promise.resolve();
    }

    Html5Qrcode.getCameras().then(devices => {
      if (!devices || devices.length === 0) {
        alert("‚ùå –ö–∞–º–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.");
        return;
      }

      // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–∞–º–µ—Ä
      devices.forEach((device, index) => {
        const option = document.createElement("option");
        option.value = device.id;
        option.text = device.label || `–ö–∞–º–µ—Ä–∞ ${index + 1}`;
        cameraSelect.appendChild(option);
      });

      // –í—ã–±–æ—Ä –∑–∞–¥–Ω–µ–π –∫–∞–º–µ—Ä—ã
      const backCam = devices.find(device =>
        device.label.toLowerCase().includes("back") ||
        device.label.toLowerCase().includes("–∑–∞–¥")
      );
      const defaultCameraId = backCam ? backCam.id : devices[0].id;

      cameraSelect.value = defaultCameraId;
      startScanner(defaultCameraId);

      // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä
      cameraSelect.addEventListener("change", async (event) => {
        const selectedId = event.target.value;
        await startScanner(selectedId);
      });
    }).catch(err => {
      alert("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∫–∞–º–µ—Ä: " + err);
    });
  </script>
</body>
</html>
