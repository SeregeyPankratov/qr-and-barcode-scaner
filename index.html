<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–°–∫–∞–Ω–µ—Ä —Å –≤—ã–±–æ—Ä–æ–º –∫–∞–º–µ—Ä—ã</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; text-align: center; }
    #reader { width: 300px; margin: 20px auto; }
    select { margin-top: 10px; padding: 5px; }
  </style>
</head>
<body>
  <h2>üì∑ –°–∫–∞–Ω–µ—Ä QR / –®—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤</h2>

  <select id="camera-select"></select>
  <div id="reader"></div>

  <script>
    const html5QrCode = new Html5Qrcode("reader");
    const cameraSelect = document.getElementById("camera-select");

    let currentCameraId = null;

    function startScanner(cameraId) {
      html5QrCode.start(
        cameraId,
        { fps: 10, qrbox: 250 },
        (decodedText) => {
          console.log("‚úÖ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ:", decodedText);
          if (window.Telegram && Telegram.WebApp) {
            Telegram.WebApp.ready();
            Telegram.WebApp.sendData(decodedText);
          } else {
            alert("Telegram WebApp API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω");
          }
          html5QrCode.stop();
        },
        (errorMessage) => {
          // –û—à–∏–±–∫–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (–º–æ–∂–Ω–æ –Ω–µ –≤—ã–≤–æ–¥–∏—Ç—å)
        }
      ).then(() => {
        currentCameraId = cameraId;
      });
    }

    function stopScanner() {
      if (html5QrCode._isScanning) {
        html5QrCode.stop().then(() => {
          console.log("–°–∫–∞–Ω–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω");
        });
      }
    }

    Html5Qrcode.getCameras().then(devices => {
      if (devices.length === 0) {
        alert("–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
        return;
      }

      // –î–æ–±–∞–≤–∏—Ç—å –∫–∞–º–µ—Ä—ã –≤ —Å–ø–∏—Å–æ–∫
      devices.forEach(device => {
        const option = document.createElement("option");
        option.value = device.id;
        option.text = device.label || `–ö–∞–º–µ—Ä–∞ ${cameraSelect.length + 1}`;
        cameraSelect.appendChild(option);
      });

      // –ó–∞–ø—É—Å–∫ –ø–µ—Ä–≤–æ–π –∫–∞–º–µ—Ä—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      startScanner(devices[0].id);

      // –ü—Ä–∏ —Å–º–µ–Ω–µ –∫–∞–º–µ—Ä—ã
      cameraSelect.addEventListener("change", (event) => {
        stopScanner();
        startScanner(event.target.value);
      });
    }).catch(err => {
      alert("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–∞–º–µ—Ä: " + err);
    });
  </script>
</body>
</html>
