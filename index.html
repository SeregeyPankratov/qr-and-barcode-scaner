<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>QR / Barcode Scanner</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
  <h1>QR / Barcode Scanner</h1>

  <div id="reader" style="width: 500px;"></div>
  <button id="restart-btn" style="margin-top: 10px;">üîÅ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>

  <script>
    const tg = window.Telegram.WebApp;

    // –°–æ–æ–±—â–∞–µ–º Telegram, —á—Ç–æ WebApp –≥–æ—Ç–æ–≤
    tg.ready();

    let html5QrcodeScanner;

    function onScanSuccess(decodedText, decodedResult) {
      console.log("–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ:", decodedText);
      alert("–†–µ–∑—É–ª—å—Ç–∞—Ç: " + decodedText);

      // ‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
      if (tg && tg.sendData) {
        tg.sendData(decodedText);
      }

      // ‚ùå –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–∞–Ω–µ—Ä
      html5QrcodeScanner.clear().then(() => {
        console.log("–°–∫–∞–Ω–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.");
      }).catch(err => {
        console.error("–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏", err);
      });
    }

    function onScanFailure(error) {
      // –ü—Ä–æ—Å—Ç–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏
    }

    function startScanner() {
      html5QrcodeScanner = new Html5Qrcode("reader");
      const config = { fps: 10, qrbox: 250 };

      html5QrcodeScanner.start(
        { facingMode: "environment" },
        config,
        onScanSuccess,
        onScanFailure
      ).catch(err => {
        alert("–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã: " + err);
      });
    }

    // –ê–≤—Ç–æ—Å—Ç–∞—Ä—Ç
    startScanner();

    // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø–æ –∫–Ω–æ–ø–∫–µ
    document.getElementById("restart-btn").addEventListener("click", () => {
      html5QrcodeScanner.stop().then(() => {
        startScanner();
      }).catch(err => {
        console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å", err);
      });
    });
  </script>
</body>
</html>
