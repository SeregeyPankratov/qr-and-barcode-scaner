<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–°–∫–∞–Ω–µ—Ä QR / –®—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤</title>
  <script src="https://telegram.org/js/telegram-web-app.js?57"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; text-align: center; }
    #reader { width: 300px; margin: 20px auto; }
    select { margin-top: 10px; padding: 5px; }
    #status { color: red; font-size: 14px; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>üì∑ –°–∫–∞–Ω–µ—Ä QR / –®—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤</h2>

  <select id="camera-select"></select>
  <div id="reader"></div>
  <div id="status"></div>

  <script>
    const statusDiv = document.getElementById("status");

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Telegram WebApp API
    if (window.Telegram && Telegram.WebApp) {
      Telegram.WebApp.ready();
      Telegram.WebApp.expand();
      console.log("‚úÖ Telegram WebApp API –¥–æ—Å—Ç—É–ø–µ–Ω");
    } else {
      statusDiv.innerText = "‚ùå Telegram WebApp API –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω. –ó–∞–ø—É—Å–∫ –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω.";
      console.error("Telegram WebApp API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω");
    }

    const html5QrCode = new Html5Qrcode("reader");
    const cameraSelect = document.getElementById("camera-select");
    let currentCameraId = null;

    function startScanner(cameraId) {
      html5QrCode.start(
        cameraId,
        { fps: 10, qrbox: 250 },
        (decodedText) => {
          console.log("‚úÖ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ:", decodedText);
          if (window.Telegram && Telegram.WebApp) {
            Telegram.WebApp.sendData(decodedText);
          } else {
            alert("Telegram WebApp API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.\n–î–∞–Ω–Ω—ã–µ: " + decodedText);
          }
          html5QrCode.stop();
        },
        (errorMessage) => {
          // –û—à–∏–±–∫–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –º–æ–∂–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å
        }
      ).then(() => {
        currentCameraId = cameraId;
      });
    }

    function stopScanner() {
      if (html5QrCode._isScanning) {
        html5QrCode.stop().then(() => {
          console.log("–°–∫–∞–Ω–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω");
        });
      }
    }

    Html5Qrcode.getCameras().then(devices => {
      if (devices.length === 0) {
        statusDiv.innerText = "‚ùå –ö–∞–º–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã";
        return;
      }

      // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç –∏ –Ω–∞—Ö–æ–¥–∏–º –∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É
      let defaultCameraId = devices[0].id;

      devices.forEach((device, index) => {
        const option = document.createElement("option");
        option.value = device.id;
        option.text = device.label || `–ö–∞–º–µ—Ä–∞ ${index + 1}`;
        cameraSelect.appendChild(option);

        // –ü—ã—Ç–∞–µ–º—Å—è –≤—ã–±—Ä–∞—Ç—å –∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É
        if (/back|rear|–∑–∞–¥/i.test(device.label)) {
          defaultCameraId = device.id;
        }
      });

      cameraSelect.value = defaultCameraId;
      startScanner(defaultCameraId);

      cameraSelect.addEventListener("change", (event) => {
        stopScanner();
        startScanner(event.target.value);
      });
    }).catch(err => {
      statusDiv.innerText = "‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–∞–º–µ—Ä: " + err;
    });
  </script>
</body>
</html>
